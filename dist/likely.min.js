!function(t){if("object"==typeof exports)module.exports=t();else if("function"==typeof define&&define.amd)define(t);else{var e;"undefined"!=typeof window?e=window:"undefined"!=typeof global?e=global:"undefined"!=typeof self&&(e=self),e.likely=t()}}(function(){return function t(e,i,r){function n(s,a){if(!i[s]){if(!e[s]){var h="function"==typeof require&&require;if(!a&&h)return h(s,!0);if(o)return o(s,!0);throw new Error("Cannot find module '"+s+"'")}var c=i[s]={exports:{}};e[s][0].call(c.exports,function(t){var i=e[s][1][t];return n(i?i:t)},c,c.exports,t,e,i,r)}return i[s].exports}for(var o="function"==typeof require&&require,s=0;s<r.length;s++)n(r[s]);return n}({1:[function(t,e){"use strict";function i(t){for(var e,i,r=[];;){var n=/{{(.+?)}}/.exec(t);if(!n){t&&r.push(t);break}e=s(n[1]),i=t.split(n[0],2),i[0].length&&r.push(i[0]),r.push(e),t=i[1]}return r}function r(t,e){var i,r="";for(i=0;i<t.length;i++){var n=t[i];r+="function"==typeof n?n(e):n}return r}function n(t){for(var e,i=0,r=t.length,n="",s=null,a=0;r>i;)e=t.charAt(i),"\\"!==e?(('"'===e||"'"===e)&&(s===e?(s=null,n+=t.slice(a,i),a=i):(n+=o(t.slice(a,i)),a=i,s=e)),i+=1):i+=2;return n+=o(t.slice(a,i))}function o(t){return t.replace(c,function(t){return t.match(/^context/)?t:'context.get("'+t+'")'})}function s(t){var e=t.match(c),i=n(t),r=new Function("context","return "+i);return e&&1==e.length&&a.trim(t)==e[0]&&(r.binding=e[0]),r}var a=t("./util"),h=/^{{(.+?)}}/,c=/[a-zA-Z_$][0-9a-zA-Z_$\.]*/gm;e.exports={nameReg:c,compileTextAndExpressions:i,evaluateExpressionList:r,jsExpression:s,replaceNames:o,replaceOutOfStrings:n,EXPRESSION_REG:h}},{"./util":5}],2:[function(t,e){"use strict";function i(t,e){var i,r=e.getAttribute("lk-bind");if(!r)throw"No lk-bind attribute on the element";i="checkbox"!=e.type||e.checked?e.value:"",t.modify(r,i)}function r(t,e,i){return this.constructor!==r?new r(t,e,i):(this.dom=t,this.data=i,this.context=new a.Context(this.data),void(this.template=e))}var n=t("./util"),o=t("./render"),s=t("./expression"),a=t("./template");r.prototype.tree=function(){return this.template.tree(new a.Context(this.data))},r.prototype.init=function(){this.dom.innerHTML="",this.currentTree=this.tree(),this.currentTree.domTree(this.dom),this.bindEvents()},r.prototype.domInit=function(){this.currentTree=o.initialRenderFromDom(this.dom),this.currentTree.nodeName=void 0,this.bindEvents()},r.prototype.diff=function(){var t=this.tree(),e=this.currentTree.diff(t);o.applyDiff(e,this.dom),this.currentTree=t,this.lock=!1},r.prototype.dataEvent=function(t){var e=t.target,r=e.getAttribute("lk-bind");if(r){var n=this.getRenderNodeFromPath(e);this.lock||(i(n.context,e),this.lock=!0,this.diff()),this.trigger("dataViewChanged",{name:r})}},r.prototype.getRenderNodeFromPath=function(t){var e,i=t.getAttribute("lk-path"),r=this.currentTree,n=i.split(".");for(e=1;e<n.length;e++)r=r.children[n[e]];return r},r.prototype.trigger=function(t,e){this.dom.dispatchEvent(n.event(t),e)},r.prototype.anyEvent=function(t){var e=t.target,i=e.getAttribute("lk-"+t.type);if(i){var r=this.getRenderNodeFromPath(e),n=a.Context({event:t},r.context);r.node.attrs["lk-"+t.type](n)}},r.prototype.bindEvents=function(){var t;this.dom.addEventListener("keyup",function(t){this.dataEvent(t)}.bind(this),!1),this.dom.addEventListener("change",function(t){this.dataEvent(t)}.bind(this),!1);var e="click,change,mouseover,focusout,focusin,keydown,keyup,keypress,submit".split(",");for(t=0;t<e.length;t++)this.dom.addEventListener(e[t],function(t){this.anyEvent(t)}.bind(this),!1)},r.prototype.update=function(){if(!this.scheduled){var t=(new Date).getTime();if(this.lastUpdate&&t-this.lastUpdate<50){var e=t;this.scheduled=setTimeout(function(){this.scheduled=!1,this.lastUpdate<e&&this.update()}.bind(this),50)}this.lock||(this.lock=!0,this.lastUpdate=t,this.diff(),this.trigger("update"))}},e.exports={Template:a.buildTemplate,ContextName:a.ContextName,updateData:i,Binding:r,Component:a.Component,getDom:o.getDom,componentCache:a.componentCache,applyDiff:o.applyDiff,diffCost:o.diffCost,attributesDiff:o.attributesDiff,Context:a.Context,CompileError:n.CompileError,RuntimeError:n.RuntimeError,escape:n.escape,initialRenderFromDom:o.initialRenderFromDom,expression:s,render:o,template:a,util:n,setHandicap:function(t){o.handicap=t}}},{"./expression":1,"./render":3,"./template":4,"./util":5}],3:[function(t,e){"use strict";function i(t,e,i,r){this.children=[],this.node=t,this.context=e,this.renderer=i,this.path=r||"",this.nodeName=t.nodeName}function r(t){var e,i=0;for(e=0;e<t.length;e++)"remove"==t[e].action&&(i+=5),"add"==t[e].action&&(i+=2),"mutate"==t[e].action&&(i+=1),"stringmutate"==t[e].action&&(i+=1);return i}function n(t,e){var i,r=[];for(i in t)e[i]===!1?r.push({action:"remove",key:i}):void 0!==e[i]?e[i]!=t[i]&&r.push({action:"mutate",key:i,value:e[i]}):r.push({action:"remove",key:i});for(i in e)void 0===t[i]&&r.push({action:"add",key:i,value:e[i]});return r}function o(t,e,i){var r,n=e.split("."),o=t;for(void 0===i&&(i=0),r=0;r<n.length-i;r++)n[r]&&(o=o.childNodes[parseInt(n[r],10)]);return o}function s(t,e){var i,r,n,s,a;for(i=0;i<t.length;i++){if(n=t[i],s=o(e,n.path),"remove"==n.action&&s.parentNode.removeChild(s),"add"==n.action){var h=n.node.domTree();s?s.parentNode.insertBefore(h,s):(a=o(e,n.path,1),a.appendChild(h))}if("mutate"==n.action)for(r=0;r<n.attributesDiff.length;r++){var c=n.attributesDiff[r];"mutate"==c.action&&(-1!="value,selected,checked".indexOf(c.key)&&s[c.key]!=c.value&&(s[c.key]=c.value),s.setAttribute(c.key,c.value)),"remove"==c.action&&(-1!="checked,selected".indexOf(c.key)&&(s[c.key]=!1),s.removeAttribute(c.key)),"add"==c.action&&(-1!="checked,selected".indexOf(c.key)&&(s[c.key]=c.value),s.setAttribute(c.key,c.value))}"stringmutate"==n.action&&(s.nodeValue=n.value)}}function a(t,e){e=e||"";var r,n,o=[],s={},h="";if(t.attributes)for(r=0;r<t.attributes.length;r++){var c=t.attributes[r];s[c.name]=c.value}if(t.childNodes)for(r=0;r<t.childNodes.length;r++)n=t.childNodes[r],o.push(a(n,e+"."+r));t.textContent&&(h=t.textContent);var d=new i({nodeName:t.nodeName.toLowerCase(),node:t},void 0,h,e);return d.attrs=s,d.children=o,d}i.prototype.repr=function(t){var e,i="";for(void 0===t&&(t=0),e=0;t>e;e++)i+="  ";for(i+=String(this.node)+" path "+this.path+"\r\n",e=0;e<this.children.length;e++)i+=this.children[e].repr(t+1);return i},i.prototype.domTree=function(t){var e,i,r=t||this.node.domNode(this.context,this.path);for(e=0;e<this.children.length;e++)i=this.children[e].domTree(),r.push?r.push(i):r.appendChild(i);return r},i.prototype.domHtml=function(){var t,e=document.createElement("div");for(t=0;t<this.children.length;t++){var i=this.children[t].domTree();e.appendChild(i)}return e.innerHTML},i.prototype._diff=function(t,i,o){var s,a,h=0;if(void 0===o&&(o=""),!t)return i.push({action:"remove",node:this,path:o}),i;if(t.nodeName!=this.nodeName)return i.push({type:"diffent_nodeName",action:"remove",node:this,path:o}),i.push({type:"diffent_nodeName",action:"add",node:t,path:o}),i;if("#text"==this.nodeName&&this.renderer!=t.renderer)return i.push({action:"stringmutate",node:this,value:t.renderer,path:o}),i;var c=n(this.attrs,t.attrs);c.length&&i.push({action:"mutate",node:this,attributesDiff:c,path:o});var d=this.children.length,l=t.children.length;for(a=0,s=0,h=0;d>s;s++){var p=0,u=0,f=0,m=null,v=null,y=t.children[a+1],g=this.children[s+1];if(t.children[a]){p=this.children[s]._diff(t.children[a],[],o+"."+h);var x=r(p);if(g&&(u=g._diff(t.children[a],[],o+"."+h),m=r(u)+e.exports.handicap),y&&(f=this.children[s]._diff(y,[],o+"."+h),v=r(f)+e.exports.handicap),(!y||v>=x)&&(!g||m>=x))i=i.concat(p),h+=1;else if(g&&(!y||v>=m))i.push({type:"after_source",action:"remove",node:this.children[s],path:o+"."+h}),i=i.concat(u),h+=1,s++;else{if(!y)throw"Should never happen";i=i.concat(f),i.push({type:"after_target",action:"add",node:t.children[a],path:o+"."+h}),h+=2,a++}a++}else i.push({action:"remove",node:this.children[s],path:o+"."+h})}for(s=0;l-a>s;s++)i.push({type:"new_node",action:"add",node:t.children[a+s],path:o+"."+(h+1)}),h+=1;return i},i.prototype.diff=function(t){var e=[];return this._diff(t,e)},e.exports={RenderedNode:i,initialRenderFromDom:a,applyDiff:s,attributesDiff:n,diffCost:r,getDom:o,handicap:1}},{}],4:[function(t,e){"use strict";function i(t,e,r){return this.constructor!==i?new i(t,e,r):(k[t]&&w.CompileError("Component with name "+t+" already exist"),k[t]=this,this.name=t,this.template=likely.Template(e),void(this.controller=r))}function r(t){this.bits=t.split(".")}function n(t,e){return this.constructor!==n?new n(t,e):(this.data=t,this.parent=e,this.aliases={},void(this.watching={}))}function o(t,e){for(var i,r,n={};t;){if(t=w.trim(t),i=t.match(O),i||e.cerror("parseAttributes: No attribute name found in "+t),t=t.substr(i[0].length),i=i[0],"="!=t[0]&&e.cerror("parseAttributes: No equal sign after name "+i),t=t.substr(1),r=t.match(R))n[i]=new v(null,r[0]);else if(r=t.match(E.EXPRESSION_REG),null===r)e.cerror("parseAttributes: No string or expression found after name "+i);else{var o=E.jsExpression(r[1]);n[i]=o}t=t.substr(r[0].length)}return n}function s(t,e,i,r){this.line=r,this.parent=t,this.content=e,this.level=i,this.children=[]}function a(t,e,i,r){s.call(this,t,e,i,r),t.children.push(this),this.renderExlcuded=!0}function h(t,e,i,r){s.call(this,t,e,i,r),this.nodeName=this.content.split(" ")[0],this.attrs=o(this.content.substr(this.nodeName.length),this),t.addChild(this)}function c(t){return t.binding?t.binding:void 0}function d(t,e){return"function"==typeof t?t(e):t.evaluate?t.evaluate(e):t}function l(t,e,i,r){s.call(this,t,e,i,r);var n,o,a;e=w.trim(e.substr(4)),n=e.match(A),n||this.cerror("first variable name is missing"),e=w.trim(e.substr(n[0].length)),","==e[0]&&(e=w.trim(e.substr(1)),o=e.match(A),o||this.cerror("second variable after comma is missing"),e=w.trim(e.substr(o[0].length))),e.match(/^in/)||this.cerror("in keyword is missing"),e=w.trim(e.substr(2)),a=e.match(E.nameReg),a||this.cerror("iterable name is missing"),this.sourceName=a[0],e=w.trim(e.substr(a[0].length)),""!==e&&this.cerror("left over unparsable content: "+e),n&&o?(this.indexName=n,this.alias=o[0]):this.alias=n[0],t.addChild(this)}function p(t,e,i,r){s.call(this,t,e,i,r),this.expression=E.jsExpression(e.replace(/^if/g,"")),t.children.push(this)}function u(t,e,i,r,n){s.call(this,t,e,i,r),this.searchIf(n)}function f(t,e,i,r,n){s.call(this,t,e,i,r),this.expression=E.jsExpression(e.replace(/^elseif/g,"")),this.searchIf(n)}function m(t,e,i,r){s.call(this,t,e,i,r),this.nodeName="#text";var n=e.match(E.EXPRESSION_REG);n||this.cerror("declared improperly"),this.expression=E.jsExpression(n[1]),t.addChild(this)}function v(t,e,i,r){s.call(this,t,e,i,r),this.nodeName="#text",this.string=this.content.replace(/^"|"$/g,"").replace(/\\"/g,'"',"gm"),this.compiledExpression=E.compileTextAndExpressions(this.string),t&&t.addChild(this)}function y(t,e,i,r){s.call(this,t,e,i,r),this.name=w.trim(e.split(" ")[1]),this.template=C[this.name],void 0===this.template&&this.cerror("Template with name "+this.name+" is not registered"),t.addChild(this)}function g(t,e,i,r){s.call(this,t,e,i,r),e=w.trim(e).substr(10);var n=e.match(A);n||this.cerror("Component name is missing"),e=w.trim(e.substr(n[0].length)),this.name=n[0],this.attrs=o(e,this),this.component=k[this.name],void 0===this.component&&this.cerror("Component with name "+this.name+" is not registered"),t.addChild(this)}function x(t,e,i,r,n){var o;if(0===e.length)o=new v(t,"\n",i,r+1);else if(0===e.indexOf("#"))o=new a(t,e,i,r+1);else if(0===e.indexOf("if "))o=new p(t,e,i,r+1);else if(0===e.indexOf("elseif "))o=new f(t,e,i,r+1,n);else if(0===e.indexOf("else"))o=new u(t,e,i,r+1,n);else if(0===e.indexOf("for "))o=new l(t,e,i,r+1);else if(0===e.indexOf("include "))o=new y(t,e,i,r+1);else if(0===e.indexOf("component "))o=new g(t,e,i,r+1);else if(0===e.indexOf('"'))o=new v(t,e,i,r+1);else if(/^\w/.exec(e))o=new h(t,e,i,r+1);else{if(0!==e.indexOf("{{"))throw new w.CompileError("createNode: unknow node type "+e);o=new m(t,e,i,r+1)}return o}function b(t,e){if(t instanceof s)return t;t instanceof Array&&(t=t.join("\n"));var i,r,n,o,a,h,c,d=new s(null,"",0),l=d;for(i=t.split("\n"),a=0;a<i.length;a++){r=i[a],n=r.match(/\s*/)[0].length+1,o=r.slice(n-1);for(var p=0;o.match(/\\$/);)p++,o=o.replace(/\\$/,"")+i[a+p];if(a+=p,p=0,o.match(/^"""/)){for(o=o.replace(/^"""/,'"');!o.match(/"""$/);){if(p++,a+p>i.length)throw new w.CompileError("Multiline string started but unfinished at line "+(a+1));o+=i[a+p]}o=o.replace(/"""$/,'"')}for(a+=p,c=l,h=null;;){if(n>c.level){h=c;break}if(!c.parent)throw new w.CompileError("Indentation error at line "+(a+1));if(n==c.level){h=c.parent;break}c=c.parent}if(h.children.length&&h.children[0].level!=n)throw new w.CompileError("Indentation error at line "+(a+1));var u=x(h,o,n,a,l);l=u}return e&&(C[e]=d),d}var w=t("./util"),N=t("./render"),E=t("./expression"),C={},k={},A=/^[a-zA-Z_$][0-9a-zA-Z_$]*/,O=/^[A-Za-z][\w-]{0,}/,R=/^"(\\"|[^"])*"/;r.prototype.substituteAlias=function(t){if(t.aliases.hasOwnProperty(this.bits[0])){var e=t.aliases[this.bits[0]].split(".");this.bits.shift(),this.bits=e.concat(this.bits)}},r.prototype.start=function(){return this.bits[0]},r.prototype.str=function(){return this.bits.join(".")},n.prototype.addAlias=function(t,e){if(t===e)throw new w.CompileError("Alias with the name "+e+" already present in this context.");this.aliases[e]=t},n.prototype.resolveName=function(t){if(t.substituteAlias(this),this.data.hasOwnProperty(t.start())){for(var e=this.data[t.start()],i=1;i<t.bits.length;){if(!e.hasOwnProperty(t.bits[i]))return void 0;e=e[t.bits[i]],i++}return[this,t.str(),e]}return this.parent?this.parent.resolveName(t):void 0},n.prototype.getNamePath=function(t){var e=this.resolveName(new r(t));return e?e[1]:void 0},n.prototype.watch=function(t,e){this.watching[t]=e},n.prototype.get=function(t){var e=this.resolveName(new r(t));return e?e[2]:void 0},n.prototype.modify=function(t,e){this._modify(new r(t),e)},n.prototype._modify=function(t,e){if(this.watching.hasOwnProperty(t.str())&&this.watching[t.str()](e),t.substituteAlias(this),this.data.hasOwnProperty(t.start())){for(var i=this.data,r=0;r<t.bits.length-1;){if(!i.hasOwnProperty(t.bits[r]))return void 0;i=i[t.bits[r]],r++}return i[t.bits[r]]=e,!0}return this.parent?this.parent._modify(t,e):void 0},n.prototype.set=function(t,e){this.data[t]=e},s.prototype.repr=function(t){var e,i="";for(void 0===t&&(t=0),e=0;t>e;e++)i+="  ";for(i+=String(this)+"\r\n",e=0;e<this.children.length;e++)i+=this.children[e].repr(t+1);return i},s.prototype.tree=function(t,e,i){void 0===e&&(e="",i=0,this.isRoot=!0);var r=new N.RenderedNode(this,t,"",e);return r.children=this.treeChildren(t,e,i),r},s.prototype.cerror=function(t){throw new w.CompileError(this.toString()+": "+t)},s.prototype.domNode=function(){return[]},s.prototype.treeChildren=function(t,e,i){var r,n,o,s=[],a=null,h=null;for(o=i,r=0;r<this.children.length;r++)n=e,h=this.children[r],h.hasOwnProperty("nodeName")?(n+="."+o,o++,a=h.tree(t,n,0),s.push(a)):h.renderExlcuded||(a=h.tree(t,n,o),a&&(s=s.concat(a),o+=a.length));return s},s.prototype.addChild=function(t){this.children.push(t)},s.prototype.toString=function(){return this.constructor.name+"("+this.content.replace("\n","")+") at line "+this.line},w.inherits(a,s),w.inherits(h,s),h.prototype.tree=function(t,e,i){var r=new N.RenderedNode(this,t,this.nodeName,e);return r.attrs=this.renderAttributes(t,e),r.children=this.treeChildren(t,e,i),r},h.prototype.renderAttributes=function(t,e){var i,r,n,o={};for(i in this.attrs)if(r=this.attrs[i],0!==i.indexOf("lk-")){var s=d(r,t);s===!1||(o[i]=s)}else o["lk-path"]=e,o[i]="lk-bind"===i?d(r,t):"true";return-1!="input,select,textarea".indexOf(this.nodeName)&&this.attrs.hasOwnProperty("value")&&(r=this.attrs.value,n=c(r),n&&void 0===this.attrs["lk-bind"]&&(o["lk-bind"]=n,o["lk-path"]=e)),"textarea"==this.nodeName&&1==this.children.length&&this.children[0].expression&&(n=c(this.children[0].expression),n&&void 0===this.attrs["lk-bind"]&&(o["lk-bind"]=n,o["lk-path"]=e,o.value=this.children[0].expression(t))),o},h.prototype.domNode=function(t,e){var i,r=document.createElement(this.nodeName),n=this.renderAttributes(t,e);for(i in n)r.setAttribute(i,n[i]);return r},w.inherits(l,s),l.prototype.tree=function(t,e,i){var r,o=[],s=t.get(this.sourceName);if(!s)return o;var a,h=Object.keys(s);for(a=0;a<h.length;a++){r=h[a];var c={};this.indexName&&(c[this.indexName]=r);var d=new n(c,t);d.addAlias(this.sourceName+"."+r,this.alias),o=o.concat(this.treeChildren(d,e,o.length+i))}return o},w.inherits(p,s),p.prototype.tree=function(t,e,i){return this.expression(t)?this.treeChildren(t,e,i):this.else?this.else.tree(t,e,i):void 0},w.inherits(u,s),u.prototype.tree=function(t,e,i){return this.treeChildren(t,e,i)},w.inherits(f,p),f.prototype.searchIf=function(t){for(;t;){if(t.level<this.level&&this.cerror("cannot find a corresponding if-like statement at the same level."),t.level==this.level){t instanceof p||this.cerror("at the same level is not a if-like statement."),t.else=this;break}t=t.parent}},u.prototype.searchIf=f.prototype.searchIf,w.inherits(m,s),m.prototype.tree=function(t,e){var i=String(d(this.expression,t)),r=new N.RenderedNode(this,t,i,e);return r},m.prototype.domNode=function(t){return document.createTextNode(d(this.expression,t))},w.inherits(v,s),v.prototype.tree=function(t,e){var i=E.evaluateExpressionList(this.compiledExpression,t),r=new N.RenderedNode(this,t,i,e);return r},v.prototype.evaluate=function(t){return E.evaluateExpressionList(this.compiledExpression,t)},v.prototype.domNode=function(t){return document.createTextNode(E.evaluateExpressionList(this.compiledExpression,t))},v.prototype.addChild=function(t){this.cerror("cannot have children "+t)},w.inherits(y,s),y.prototype.tree=function(t,e,i){return this.template.treeChildren(t,e,i)},w.inherits(g,s),g.prototype.tree=function(t,e,i){var r,o,s,a,h=new n({},t);for(r in this.attrs)o=this.attrs[r],s=d(o,t),h.set(r,s),"function"==typeof o&&(a=c(o),a&&r!=a&&h.addAlias(a,r));return this.component.controller&&this.component.controller(h),this.component.template.treeChildren(h,e,i)},g.prototype.repr=function(t){return this.component.template.repr(t+1)},e.exports={buildTemplate:b,parseAttributes:o,Context:n,templateCache:C,componentCache:k,ContextName:r,Component:i}},{"./expression":1,"./render":3,"./util":5}],5:[function(t,e){"use strict";function i(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t}function r(t){this.name="CompileError",this.message=t||""}function n(t){this.name="RuntimeError",this.message=t||""}function o(t){return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function s(t){return t.replace(/^\s+|\s+$/g,"")}function a(t,e){var i=document.createEvent("CustomEvent");return i.initCustomEvent(t,!1,!1,e),i}r.prototype=Error.prototype,n.prototype=Error.prototype,e.exports={inherits:i,CompileError:r,RuntimeError:n,escape:o,trim:s,event:a}},{}]},{},[2])(2)});